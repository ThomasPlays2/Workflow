<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Local Toolkit — Single File (Extended)</title>
  <meta name="description" content="Extended single-file advanced local web toolkit: file manager, image editor, audio analyzer, markdown & HTML live preview, mini-terminal, command palette, presets, more utilities." />
  <style>
    :root{
      --bg:#0f1115;--panel:#0b0d10;--muted:#9aa4b2;--accent:#6ee7b7;--glass:rgba(255,255,255,0.03);--glass-2:rgba(255,255,255,0.02);--card:#0b0f14;--danger:#ff6b6b
      }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color: #e6eef6;background: linear-gradient(180deg,#071018 0%, #0f1621 100%);}
    .app{display:grid;grid-template-columns:300px 1fr 460px;grid-template-rows:64px 1fr;grid-template-areas:"sidebar header header" "sidebar main right";height:100vh;gap:14px;padding:14px}
    header{grid-area:header;display:flex;align-items:center;gap:14px;padding:14px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(4,8,12,0.6)}
    .sidebar{grid-area:sidebar;background:var(--panel);padding:16px;border-radius:12px;overflow:auto}
    .main{grid-area:main;background:linear-gradient(180deg,var(--glass),transparent);padding:16px;border-radius:12px;overflow:auto}
    .right{grid-area:right;background:var(--panel);padding:16px;border-radius:12px;overflow:auto}
    h1{font-size:16px;margin:0}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:36px;height:36px}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav button{background:transparent;border:0;color:var(--muted);padding:10px;border-radius:8px;text-align:left;cursor:pointer}
    .nav button.active{color:var(--accent);background:linear-gradient(90deg,rgba(110,231,183,0.06),transparent)}
    .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px}
    .flex{display:flex;gap:12px;align-items:center}
    .grow{flex:1}
    /* Editor styles */
    .editor{height:360px;background:#02050a;border-radius:10px;padding:8px;color:#d6e6ff;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px}
    .preview{height:360px;background:#fff;border-radius:10px;padding:8px;overflow:auto}
    .toolbar{display:flex;gap:8px;align-items:center}
    input[type=range]{width:100%}
    .file-drop{border:2px dashed rgba(255,255,255,0.03);padding:18px;border-radius:10px;text-align:center;color:var(--muted)}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .thumb{width:110px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer}
    canvas{max-width:100%}
    .mini-term{background:#02040a;color:#bfeee0;padding:12px;border-radius:8px;font-family:ui-monospace,monospace;height:180px;overflow:auto}
    .kbd{background:#061019;padding:6px 8px;border-radius:6px;font-size:12px;color:var(--muted)}
    .toggle{display:inline-flex;align-items:center;padding:6px;border-radius:999px;background:var(--glass-2);gap:6px}
    .btn{background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    footer{font-size:12px;color:var(--muted);opacity:0.9}

    /* small badges */
    .badge{background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}

    /* modals and overlays */
    .overlay{position:fixed;inset:0;background:rgba(2,6,10,0.6);display:none;align-items:center;justify-content:center}
    .modal{background:linear-gradient(180deg,#071018,#0b1014);padding:18px;border-radius:12px;width:min(920px,95%);max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,0.03)}

    /* command palette */
    .palette{width:640px;max-width:92%;background:#041018;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .palette input{width:100%;padding:10px;border-radius:8px;background:#020611;border:1px solid rgba(255,255,255,0.02);color:#d6e6ff}
    .palette ul{list-style:none;margin:8px 0 0 0;padding:0;max-height:240px;overflow:auto}
    .palette li{padding:8px;border-radius:6px;cursor:pointer}
    .palette li:hover{background:rgba(255,255,255,0.02)}

    /* responsive */
    @media (max-width:1100px){.app{grid-template-columns:1fr;grid-template-areas:"header" "main";grid-template-rows:64px 1fr}.right,.sidebar{display:none}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar">
      <div class="logo"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" fill="#0b1220"/><path d="M5 12h14" stroke="currentColor" stroke-opacity="0.12" stroke-width="1.5"/><path d="M7 8h10v8H7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
        <div>
          <h1>Local Toolkit</h1>
          <div style="font-size:12px;color:var(--muted)">single-file — offline-first (extended)</div>
        </div>
      </div>
      <div class="nav" role="navigation" aria-label="Main">
        <button class="active" data-view="dashboard">Dashboard</button>
        <button data-view="file">Files</button>
        <button data-view="images">Images</button>
        <button data-view="audio">Audio</button>
        <button data-view="editor">Editors</button>
        <button data-view="tools">Tools</button>
        <button data-view="settings">Settings</button>
      </div>
      <div style="margin-top:12px">
        <div class="card">
          <div style="display:flex;justify-content:space-between"><strong>Quick actions</strong><span class="kbd">Ctrl+K</span></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" id="btn-import">Import</button>
            <button class="btn" id="btn-clear">Clear</button>
            <button class="btn" id="open-palette">Cmd Palette</button>
          </div>
        </div>
        <div class="card">
          <strong>Storage</strong>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Saved items: <span id="stat-count">0</span></div>
          <div style="margin-top:8px"><button class="btn" id="export-btn">Export JSON</button></div>
        </div>
      </div>
      <footer style="margin-top:12px">Built for Thomas • Local only • No external requests</footer>
    </aside>

    <header>
      <div style="display:flex;align-items:center;gap:12px;width:100%">
        <div style="display:flex;align-items:center;gap:12px">
          <div><strong id="view-title">Dashboard</strong></div>
          <div style="color:var(--muted);font-size:13px">— an offline playground (extended)</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <div class="toggle" title="Theme">
            <label style="font-size:13px;color:var(--muted)">Theme</label>
            <input type="checkbox" id="theme-toggle" aria-label="Toggle theme" />
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="kbd">local</div>
            <button class="btn" id="help-btn">Help</button>
          </div>
        </div>
      </div>
    </header>

    <main class="main" id="main">
      <!-- views loaded here -->
      <section id="dashboard" class="view">
        <div class="card" style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <h2 style="margin:0">Welcome — your extended local workbench</h2>
            <p style="color:var(--muted)">This extended single-file site includes everything from the original plus: command palette, presets, image crop, improved markdown, file search, draggable thumbs, and more helpful utilities.</p>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" data-action="open-view" data-target="images">Open Image Lab</button>
              <button class="btn" data-action="open-view" data-target="audio">Open Audio Lab</button>
              <button class="btn" data-action="open-view" data-target="tools">Open Tools</button>
            </div>
          </div>
          <div style="width:320px">
            <div style="background:linear-gradient(180deg,#06121a,transparent);padding:12px;border-radius:10px">
              <div style="font-size:12px;color:var(--muted)">Storage usage (approx)</div>
              <div style="font-weight:700;font-size:20px">LocalStorage: <span id="storage-size">0 KB</span></div>
              <div style="margin-top:8px;color:var(--muted);font-size:12px">IndexedDB: <span id="idx-status">unknown</span></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0">Quick file drop (images, audio, text)</h3>
          <div id="drop" class="file-drop" tabindex="0">Drop files here or click to select — images & audio will be processed automatically</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center"><input id="search-files" class="grow" placeholder="search files by name" style="padding:8px;border-radius:8px;background:#07111a;border:1px solid rgba(255,255,255,0.02);color:#d6e6ff"/><button class="btn" id="btn-search">Search</button></div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div class="card" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4 style="margin:0">Mini terminal</h4>
            <div id="mini-term" class="mini-term" aria-live="polite"></div>
            <div style="display:flex;gap:8px;margin-top:8px"><input id="term-input" placeholder="type help" class="grow" style="padding:8px;border-radius:8px;background:#07111a;border:1px solid rgba(255,255,255,0.02);color:#d6e6ff" /><button class="btn" id="term-send">Run</button></div>
          </div>
          <div>
            <h4 style="margin:0">Clipboard & snippets</h4>
            <textarea id="snip" style="width:100%;height:180px;margin-top:8px;background:#02050a;color:#d6e6ff;border-radius:8px;padding:8px"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="save-snip">Save Snippet</button><button class="btn" id="load-snip">Load Snippet</button><button class="btn" id="copy-snip">Copy</button></div>
          </div>
        </div>
      </section>

      <section id="file" class="view" style="display:none">
        <div class="card">
          <h3>File Manager</h3>
          <input id="file-input" type="file" multiple style="margin-top:8px" />
          <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" id="save-file-list">Save manifest</button><button class="btn" id="clear-storage">Clear saved</button><button class="btn" id="download-all">Download All</button></div>
          <div id="file-list" style="margin-top:12px;color:var(--muted);white-space:pre-wrap"></div>
        </div>
      </section>

      <section id="images" class="view" style="display:none">
        <div class="card">
          <h3>Image Lab</h3>
          <div style="display:grid;grid-template-columns:1fr 380px;gap:12px">
            <div>
              <div id="image-canvas-wrap" style="background:#081018;padding:8px;border-radius:8px">
                <canvas id="img-canvas" width="900" height="540"></canvas>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px;font-size:13px">
                <div style="flex:1">
                  <label>Brightness <input id="brightness" type="range" min="-100" max="100" value="0"></label>
                </div>
                <div style="flex:1">
                  <label>Contrast <input id="contrast" type="range" min="-100" max="100" value="0"></label>
                </div>
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" id="crop-toggle">Crop</button>
                <button class="btn" id="reset-filters">Reset</button>
                <select id="presets" style="background:#07111a;border:1px solid rgba(255,255,255,0.02);padding:6px;border-radius:6px;color:#d6e6ff">
                  <option value="none">Presets</option>
                  <option value="film">Film look</option>
                  <option value="bw">B&W high contrast</option>
                  <option value="vivid">Vivid boost</option>
                </select>
              </div>
            </div>
            <div>
              <div style="display:flex;gap:8px;align-items:center;justify-content:space-between"><div style="font-weight:700">Histogram</div><div style="font-size:12px;color:var(--muted)">preview</div></div>
              <canvas id="histogram" width="360" height="180" style="margin-top:8px;background:#050711;border-radius:8px"></canvas>
              <div style="margin-top:8px"><button class="btn" id="export-image">Export PNG</button><button class="btn" id="download-original">Download Original</button></div>
              <div style="margin-top:8px;color:var(--muted);font-size:13px">Image info: <span id="img-info">no image</span></div>
              <div style="margin-top:12px;background:#07121a;padding:8px;border-radius:8px"><strong>Crop</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Use toggle to enable selection and crop the image.</div></div>
            </div>
          </div>
        </div>
      </section>

      <section id="audio" class="view" style="display:none">
        <div class="card">
          <h3>Audio Lab</h3>
          <input id="audio-input" type="file" accept="audio/*" style="margin-top:8px" />
          <div style="display:flex;gap:8px;margin-top:12px">
            <div style="flex:1">
              <div id="audio-controls" style="background:#07121a;padding:12px;border-radius:8px">
                <div id="audio-meta" style="color:var(--muted)">No audio loaded</div>
                <canvas id="audio-visual" width="720" height="120" style="margin-top:8px;background:#02040a;border-radius:8px"></canvas>
                <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="play-audio">Play</button><button class="btn" id="pause-audio">Stop</button><button class="btn" id="sine-test">Sine Demo</button></div>
              </div>
            </div>
            <div style="width:260px;display:flex;flex-direction:column;gap:8px">
              <div style="background:#07121a;padding:8px;border-radius:8px"><strong>FFT</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Realtime frequency analysis. Use the slider to change detail.</div><input id="fft-size" type="range" min="256" max="4096" step="256" value="2048"></div>
              <div style="background:#07121a;padding:8px;border-radius:8px"><strong>Options</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Fast/precise modes</div><label style="display:block;margin-top:6px"><input type="checkbox" id="show-freq" checked /> show frequencies</label></div>
            </div>
          </div>
        </div>
      </section>

      <section id="editor" class="view" style="display:none">
        <div class="card">
          <h3>Editors</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div style="display:flex;gap:8px;align-items:center"><strong>Markdown</strong><div style="margin-left:auto;color:var(--muted);font-size:12px">Live preview</div></div>
              <textarea id="md-input" class="editor" placeholder="# Hello\nType markdown here"></textarea>
            </div>
            <div>
              <div style="display:flex;gap:8px;align-items:center"><strong>Preview</strong><div style="margin-left:auto;color:var(--muted);font-size:12px">Sanitized</div></div>
              <div id="md-preview" class="preview"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <strong>HTML Playground</strong>
              <textarea id="html-input" class="editor">&lt;h1&gt;Live HTML&lt;/h1&gt;&lt;p&gt;Edit and preview&lt;/p&gt;</textarea>
            </div>
            <div>
              <strong>Result</strong>
              <iframe id="html-preview" class="preview" sandbox="allow-scripts allow-forms" title="preview"></iframe>
            </div>
          </div>
        </div>
      </section>

      <section id="tools" class="view" style="display:none">
        <div class="card">
          <h3>Utilities</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btn-random-color">Random Palette</button>
            <button class="btn" id="btn-uid">Generate UID</button>
            <button class="btn" id="btn-time">Current Time</button>
            <button class="btn" id="btn-clear-cache">Clear LocalStorage</button>
            <button class="btn" id="btn-preview-html">Preview small HTML</button>
            <button class="btn" id="btn-generate-sample">Generate Sample Files</button>
          </div>
          <div id="tool-output" style="margin-top:12px;color:var(--muted)"></div>
        </div>
        <div class="card">
          <h4>Small utilities</h4>
          <div style="display:flex;gap:8px"><input id="color-swatch" placeholder="#rrggbb" class="grow" style="padding:8px;border-radius:8px;background:#07111a;border:1px solid rgba(255,255,255,0.02);color:#d6e6ff"/><button class="btn" id="apply-color">Apply Theme Accent</button></div>
        </div>
      </section>

      <section id="settings" class="view" style="display:none">
        <div class="card">
          <h3>Settings</h3>
          <div style="display:flex;gap:8px;align-items:center"><label>Autosave editors</label><input type="checkbox" id="autosave" /></div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">All data stays in your browser. Use Export to back up.</div>
          <div style="margin-top:8px"><label>Editor font size</label><input id="font-size" type="range" min="12" max="18" value="13" /></div>
        </div>
      </section>

    </main>

    <aside class="right">
      <div class="card">
        <h4>Inspector</h4>
        <div style="font-size:13px;color:var(--muted);margin-top:6px">Selected: <span id="ins-selected">none</span></div>
        <div style="margin-top:8px"><strong>Shortcuts</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Ctrl+S save, Ctrl+K command palette, / open palette</div></div>
      </div>

      <div class="card">
        <h4>About</h4>
        <div style="font-size:13px;color:var(--muted);margin-top:6px">Single-file app — extended by ChatGPT. All local. If something fails due to file:// security, run a local server (python -m http.server).</div>
      </div>

      <div class="card">
        <h4>Quick presets</h4>
        <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
          <button class="btn" data-preset="film">Film preset</button>
          <button class="btn" data-preset="bw">B&amp;W preset</button>
          <button class="btn" data-preset="vivid">Vivid preset</button>
        </div>
      </div>

    </aside>

  </div>

  <!-- overlays -->
  <div id="overlay" class="overlay"><div class="modal" role="dialog" aria-modal="true"><div id="modal-content"></div><div style="text-align:right;margin-top:12px"><button class="btn" id="close-modal">Close</button></div></div></div>
  <div id="palette-overlay" class="overlay" style="display:none;align-items:flex-start;padding-top:120px"><div class="palette" role="dialog"><input id="palette-input" placeholder="Type a command (help, open files, export, uid)"/><ul id="palette-list"></ul></div></div>

  <script>
  // --- Utilities & state ---
  const state = {files:[],images:[],audio:null,settings:{theme:'dark',autosave:false,fontSize:13}};
  const el = (sel)=>document.querySelector(sel);
  const els = (sel)=>Array.from(document.querySelectorAll(sel));

  // Navigation
  els('.nav button').forEach(b=>b.addEventListener('click',()=>{els('.nav button').forEach(x=>x.classList.remove('active'));b.classList.add('active');showView(b.dataset.view);}));
  els('[data-action=open-view]').forEach(b=>b.addEventListener('click',e=>showView(e.target.dataset.target)));
  function showView(id){els('.view').forEach(v=>v.style.display='none');const s=document.getElementById(id);if(s)s.style.display='block';el('#view-title').textContent=id.charAt(0).toUpperCase()+id.slice(1);} 

  // Theme toggle
  const themeToggle = el('#theme-toggle');
  themeToggle.addEventListener('change',e=>{document.documentElement.style.setProperty('--bg', e.target.checked ? '#ffffff':'#0f1115');state.settings.theme = e.target.checked? 'light':'dark';localStorage.setItem('localtool.settings',JSON.stringify(state.settings));});
  // Load settings
  (function loadSettings(){try{const s=JSON.parse(localStorage.getItem('localtool.settings'));if(s){state.settings = {...state.settings,...s};if(state.settings.theme==='light') themeToggle.checked = true; if(state.settings.autosave) el('#autosave').checked=true; if(state.settings.fontSize) el('#font-size').value=state.settings.fontSize; el('#font-size').dispatchEvent(new Event('input'));}}catch(e){console.warn(e)}
  })();

  // Drop zone
  const drop = el('#drop');
  drop.addEventListener('dragover',e=>{e.preventDefault();drop.style.borderColor='#2bffcc'});
  ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>{drop.style.borderColor=''}));
  drop.addEventListener('drop',async e=>{e.preventDefault();handleFiles(e.dataTransfer.files)});
  drop.addEventListener('click',()=>el('#file-input').click());

  el('#file-input').addEventListener('change',e=>handleFiles(e.target.files));
  el('#audio-input').addEventListener('change',e=>handleAudio(e.target.files[0]));

  function createThumbElement(file,url){const img = document.createElement('img');img.src = url;img.className='thumb';img.title=file.name;img.draggable=true;img.dataset.name=file.name;el('#thumbs').appendChild(img);
    img.addEventListener('click',()=>{loadImageToCanvas(url,file)});
    // drag reorder support
    img.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',file.name)});
    img.addEventListener('dblclick',()=>{openPreviewModal(file,url)});
    return img;
  }

  function appendThumb(file,url){createThumbElement(file,url);}

  async function handleFiles(files){for(const f of files){const url = URL.createObjectURL(f);state.files.push({name:f.name,type:f.type,size:f.size,url,ts:Date.now()});if(f.type.startsWith('image/')){appendThumb(f,url);state.images.push({file:f,url});}else if(f.type.startsWith('audio/')){handleAudio(f);}else{pushLog('file: ' + f.name);}updateStats();}} 

  function updateStats(){el('#stat-count').textContent = state.files.length;el('#storage-size').textContent = Math.round(JSON.stringify(localStorage).length/1024) + ' KB'}

  // --- Mini terminal ---
  const term = el('#mini-term');
  function pushLog(txt){const line = document.createElement('div');line.textContent = '> '+txt;term.appendChild(line);term.scrollTop = term.scrollHeight}
  el('#term-send').addEventListener('click',()=>runCmd(el('#term-input').value));
  el('#term-input').addEventListener('keydown',e=>{if(e.key==='Enter') runCmd(e.target.value)});
  function runCmd(cmd){if(!cmd) return;pushLog(cmd);const p=cmd.split(' ');switch(p[0]){case 'help':pushLog('commands: help, ls, clear, export, uid, time, open images');break;case 'ls':pushLog(state.files.map(f=>f.name).join(', ')||'no files');break;case 'clear':state.files=[];state.images=[];localStorage.removeItem('localtool.files');el('#thumbs').innerHTML='';updateStats();pushLog('cleared');break;case 'export':downloadJSON();break;case 'uid':pushLog(generateUID());break;case 'time':pushLog(new Date().toString());break;case 'open': if(p[1]==='images'){showView('images')} pushLog('opened view');break;default:pushLog('unknown command');}}

  // --- Snippets ---
  el('#save-snip').addEventListener('click',()=>{localStorage.setItem('localtool.snip',el('#snip').value);pushLog('snippet saved')});
  el('#load-snip').addEventListener('click',()=>{el('#snip').value = localStorage.getItem('localtool.snip')||'';pushLog('snippet loaded')});
  el('#copy-snip').addEventListener('click',()=>{navigator.clipboard.writeText(el('#snip').value||'');pushLog('copied to clipboard')});

  // --- Image canvas & filters/histogram & crop ---
  const imgCanvas = el('#img-canvas'); const imgCtx = imgCanvas.getContext('2d'); let currentImage = null; let originalImageData = null; let cropMode=false; let cropRect=null;
  function loadImageToCanvas(src,file){const img=new Image();img.onload=()=>{const w=Math.min(1400,img.width);const h=Math.floor(img.height*(w/img.width));imgCanvas.width=w;imgCanvas.height=h;imgCtx.clearRect(0,0,w,h);imgCtx.drawImage(img,0,0,w,h);originalImageData = imgCtx.getImageData(0,0,w,h);currentImage={img,source:src,file};el('#img-info').textContent = file? file.name + ' ('+file.type +', '+Math.round(file.size/1024)+'KB)':'image';computeHistogram();};img.crossOrigin='anonymous';img.src=src}
  el('#brightness').addEventListener('input',applyFilters);el('#contrast').addEventListener('input',applyFilters);
  el('#presets').addEventListener('change',e=>{const v=e.target.value;applyPreset(v)});
  el('#reset-filters').addEventListener('click',()=>{el('#brightness').value=0;el('#contrast').value=0;applyFilters()});
  el('#crop-toggle').addEventListener('click',()=>{cropMode=!cropMode;el('#crop-toggle').textContent = cropMode? 'Exit crop':'Crop';if(!cropMode) cropRect=null;renderCanvas()});

  function applyPreset(name){if(!originalImageData) return; if(name==='film'){el('#brightness').value = 6; el('#contrast').value=12}else if(name==='bw'){el('#brightness').value=0; el('#contrast').value=40}else if(name==='vivid'){el('#brightness').value=8; el('#contrast').value=28} applyFilters();}

  function applyFilters(){if(!originalImageData) return;const bright = Number(el('#brightness').value);const contrast = Number(el('#contrast').value);const data = new Uint8ClampedArray(originalImageData.data);const factor = (259*(contrast+255))/(255*(259-contrast));for(let i=0;i<data.length;i+=4){for(let c=0;c<3;c++){let v = data[i+c]; v = factor*(v-128)+128; v += bright; data[i+c]=Math.max(0,Math.min(255, v));}}const id = new ImageData(data, originalImageData.width, originalImageData.height);imgCtx.putImageData(id,0,0);computeHistogram();renderCanvas();}

  function renderCanvas(){if(!currentImage) return; if(cropMode && cropRect){ // draw overlay
      imgCtx.putImageData(new ImageData(new Uint8ClampedArray(originalImageData.data),originalImageData.width,originalImageData.height),0,0);
      imgCtx.strokeStyle='rgba(110,231,183,0.9)'; imgCtx.lineWidth=2; imgCtx.strokeRect(cropRect.x,cropRect.y,cropRect.w,cropRect.h);
      imgCtx.fillStyle='rgba(0,0,0,0.35)'; // shade outside
      imgCtx.beginPath(); imgCtx.rect(0,0,imgCanvas.width,imgCanvas.height); imgCtx.rect(cropRect.x,cropRect.y,cropRect.w,cropRect.h); imgCtx.fill('evenodd');
    }}

  function computeHistogram(){const w=imgCanvas.width,h=imgCanvas.height;const id = imgCtx.getImageData(0,0,w,h);const bins=new Uint32Array(256);for(let i=0;i<id.data.length;i+=4){const r=id.data[i],g=id.data[i+1],b=id.data[i+2];const lum = Math.floor(0.2126*r+0.7152*g+0.0722*b);bins[lum]++;}
    const c = el('#histogram');const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);const max = Math.max(...bins)||1;for(let i=0;i<256;i++){const hval = (bins[i]/max)*(c.height-4);ctx.fillStyle='rgba(110,231,183,0.9)';ctx.fillRect(i*(c.width/256),c.height-hval,Math.max(1,c.width/256),hval);} }

  el('#export-image').addEventListener('click',()=>{if(!currentImage) return;const a=document.createElement('a');a.href=imgCanvas.toDataURL('image/png');a.download='edited-'+(currentImage.file?currentImage.file.name:'image')+'.png';a.click()});
  el('#download-original').addEventListener('click',()=>{if(!currentImage) return;const a=document.createElement('a');a.href=currentImage.source;a.download=currentImage.file? currentImage.file.name: 'image';a.click()});

  // crop interaction
  let dragStart=null;
  imgCanvas.addEventListener('mousedown',e=>{if(!cropMode) return; dragStart = {x:e.offsetX,y:e.offsetY}; cropRect = {x:dragStart.x,y:dragStart.y,w:0,h:0};});
  imgCanvas.addEventListener('mousemove',e=>{if(!cropMode || !dragStart) return; const x=e.offsetX,y=e.offsetY; cropRect.w = x-dragStart.x; cropRect.h = y-dragStart.y; cropRect.x = Math.min(dragStart.x,x); cropRect.y = Math.min(dragStart.y,y); renderCanvas();});
  imgCanvas.addEventListener('mouseup',e=>{if(!cropMode) return; dragStart=null; // cropRect is ready
    if(cropRect && Math.abs(cropRect.w)>10 && Math.abs(cropRect.h)>10){ // perform crop
      const tmp = document.createElement('canvas'); tmp.width = Math.abs(cropRect.w); tmp.height = Math.abs(cropRect.h); tmp.getContext('2d').drawImage(imgCanvas, cropRect.x, cropRect.y, cropRect.w, cropRect.h, 0, 0, tmp.width, tmp.height); imgCanvas.width = tmp.width; imgCanvas.height = tmp.height; imgCtx.clearRect(0,0,tmp.width,tmp.height); imgCtx.drawImage(tmp,0,0); originalImageData = imgCtx.getImageData(0,0,tmp.width,tmp.height); pushLog('cropped'); cropMode=false; el('#crop-toggle').textContent='Crop'; }
  });

  // --- Audio handling & analyser ---
  let audioCtx,analyser,sourceNode,audioBuffer,animId, audioElem,oscNode; let sinePlaying=false;
  async function handleAudio(file){if(!file) return;const arr = await file.arrayBuffer();if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();audioBuffer = await audioCtx.decodeAudioData(arr.slice(0));el('#audio-meta').textContent = file.name + ' — ' + Math.round(file.size/1024)+'KB';setupAudioNodes();}
  function setupAudioNodes(){try{if(!audioBuffer) return;if(sourceNode){try{sourceNode.disconnect();}catch(e){} }analyser = audioCtx.createAnalyser();analyser.fftSize = Number(el('#fft-size').value)||2048;sourceNode = audioCtx.createBufferSource();sourceNode.buffer = audioBuffer;sourceNode.connect(analyser);analyser.connect(audioCtx.destination);const canvas=el('#audio-visual');const ctx=canvas.getContext('2d');function draw(){const data = new Uint8Array(analyser.fftSize);analyser.getByteTimeDomainData(data);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.beginPath();for(let i=0;i<data.length;i+=4){const v = data[i]/128.0;const y = (v*canvas.height)/2;if(i===0) ctx.moveTo(i/data.length*canvas.width,y); else ctx.lineTo(i/data.length*canvas.width,y);}ctx.strokeStyle='rgba(110,231,183,0.9)';ctx.stroke();animId=requestAnimationFrame(draw);} draw();}catch(e){console.warn(e)}}
  el('#play-audio').addEventListener('click',()=>{try{if(!audioBuffer) return; if(!sourceNode){setupAudioNodes()} sourceNode.start(0);}catch(e){ // restart logic
      try{setupAudioNodes(); sourceNode.start(0);}catch(err){console.warn(err)} }});
  el('#pause-audio').addEventListener('click',()=>{try{if(sourceNode) sourceNode.stop(); if(animId) cancelAnimationFrame(animId);}catch(e){}});
  // sine demo
  el('#sine-test').addEventListener('click',()=>{if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(!sinePlaying){oscNode = audioCtx.createOscillator();oscNode.type='sine';oscNode.frequency.value = 440;oscNode.connect(audioCtx.destination);oscNode.start();sinePlaying=true;el('#sine-test').textContent='Stop Demo';pushLog('sine started')}else{oscNode.stop();sinePlaying=false;el('#sine-test').textContent='Sine Demo';pushLog('sine stopped')}});
  el('#fft-size').addEventListener('input',()=>{if(analyser) analyser.fftSize = Number(el('#fft-size').value)});

  // --- Markdown rendering (improved sanitizer + markdown) ---
  function mdToHtml(md){ // improved small markdown -> html (headers, bold, lists, code, links)
    const esc = (s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const lines = md.split('\n');let out='';let inList=false;let inCode=false;let codeBlock='';
    for(let raw of lines){let l = raw.replace(/\t/g,'  ');
      if(/^```/.test(l)){inCode=!inCode; if(inCode){codeBlock='';} else {out+='<pre><code>'+esc(codeBlock)+'</code></pre>';} continue}
      if(inCode){codeBlock += l+'\n'; continue}
      if(/^\s*$/.test(l)){ if(inList){out+='</ul>';inList=false;} out+='<p></p>'; continue;} if(/^#{1,6}\s/.test(l)){ const c = l.match(/^#{1,6}/)[0].length; out+=`<h${c}>${esc(l.replace(/^#{1,6}\s/,'').trim())}</h${c}>`; continue;} if(/^\*\s+/.test(l)){ if(!inList){out+='<ul>';inList=true;} out+='<li>'+esc(l.replace(/^\*\s+/,''))+'</li>'; continue;} // inline links
      l = l.replace(/\[(.*?)\]\((.*?)\)/g,(m,t,u)=>`<a href="${u}" target="_blank" rel="noreferrer">${esc(t)}</a>`);
      // inline bold and italics
      l = l.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      l = l.replace(/\*(.+?)\*/g,'<em>$1</em>');
      out+='<p>'+l+'</p>';
    }
    if(inList) out+='</ul>';
    return out;
  }
  el('#md-input').addEventListener('input',e=>{el('#md-preview').innerHTML = mdToHtml(e.target.value); if(el('#autosave').checked) localStorage.setItem('localtool.md',e.target.value)});
  // load saved
  if(localStorage.getItem('localtool.md')) el('#md-input').value = localStorage.getItem('localtool.md'); el('#md-input').dispatchEvent(new Event('input'));

  // HTML playground
  el('#html-input').addEventListener('input',e=>{const frame = el('#html-preview');const doc = frame.contentDocument || frame.contentWindow.document;doc.open();doc.write(e.target.value);doc.close(); if(el('#autosave').checked) localStorage.setItem('localtool.html',e.target.value)});
  if(localStorage.getItem('localtool.html')) el('#html-input').value = localStorage.getItem('localtool.html'); el('#html-input').dispatchEvent(new Event('input'));

  // Tools
  el('#btn-random-color').addEventListener('click',()=>{const pal = Array.from({length:5},()=>'#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'));el('#tool-output').textContent = 'Palette: '+pal.join(', ');});
  el('#btn-uid').addEventListener('click',()=>{el('#tool-output').textContent = 'UID: '+generateUID()});
  el('#btn-time').addEventListener('click',()=>{el('#tool-output').textContent = new Date().toString()});
  el('#btn-clear-cache').addEventListener('click',()=>{localStorage.clear();pushLog('localStorage cleared');});
  el('#btn-preview-html').addEventListener('click',()=>{showModal('<h3>Small HTML</h3><div style="background:#fff;color:#000;padding:8px;border-radius:6px">'+el('#html-input').value+'</div>')});
  el('#btn-generate-sample').addEventListener('click',generateSampleFiles);

  function generateUID(){return 'id-'+Math.random().toString(36).slice(2,10)+'-'+Date.now().toString(36)}

  // Export/import
  function downloadJSON(){const data = {files:state.files,images:state.images.map(i=>({name:i.file.name,type:i.file.type,size:i.file.size}))};const a=document.createElement('a');a.href='data:application/json,'+encodeURIComponent(JSON.stringify(data,null,2));a.download='localtool-export-'+Date.now()+'.json';a.click();}
  el('#export-btn').addEventListener('click',downloadJSON);

  // Save & load
  el('#save-file-list').addEventListener('click',()=>{localStorage.setItem('localtool.files',JSON.stringify(state.files));pushLog('manifest saved')});
  el('#clear-storage').addEventListener('click',()=>{localStorage.removeItem('localtool.files');pushLog('saved files cleared')});

  // buttons
  el('#btn-import').addEventListener('click',()=>el('#file-input').click());
  el('#btn-clear').addEventListener('click',()=>{state.files=[];state.images=[];localStorage.removeItem('localtool.files');el('#thumbs').innerHTML='';updateStats();pushLog('workspace cleared')});

  // keyboard shortcuts
  window.addEventListener('keydown',(e)=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){e.preventDefault();localStorage.setItem('localtool.md',el('#md-input').value);pushLog('saved');} if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();openPalette();} if(e.key==='/'){e.preventDefault();openPalette();}})

  // command palette
  function openPalette(){el('#palette-overlay').style.display='flex';el('#palette-input').focus();populatePalette('');}
  el('#open-palette').addEventListener('click',openPalette);
  el('#palette-input').addEventListener('input',e=>populatePalette(e.target.value));
  el('#palette-input').addEventListener('keydown',e=>{if(e.key==='Escape') closePalette(); if(e.key==='Enter'){const first = el('#palette-list li'); if(first) first.click();}});
  function closePalette(){el('#palette-overlay').style.display='none';el('#palette-input').value='';}
  el('#palette-overlay').addEventListener('click',e=>{if(e.target.id==='palette-overlay') closePalette()});

  const commands = [
    {title:'Help',act:()=>showHelp()},
    {title:'Open Images',act:()=>showView('images')},
    {title:'Open Audio',act:()=>showView('audio')},
    {title:'Export JSON',act:()=>downloadJSON()},
    {title:'Generate UID',act:()=>pushLog(generateUID())}
  ];
  function populatePalette(filter){const ul=el('#palette-list');ul.innerHTML='';commands.filter(c=>c.title.toLowerCase().includes(filter.toLowerCase())).forEach(c=>{const li=document.createElement('li');li.textContent=c.title;li.addEventListener('click',()=>{c.act();closePalette()});ul.appendChild(li)})}

  // help
  function showHelp(){showModal('<h3>Local Toolkit — quick help</h3><ul><li>Drag & drop files</li><li>Ctrl+K / / open command palette</li><li>Image crop: toggle, draw a rectangle</li><li>Mini terminal: try "ls", "uid", "export"</li></ul>')}
  el('#help-btn').addEventListener('click',showHelp);

  // modal helpers
  function showModal(html){el('#modal-content').innerHTML = html; el('#overlay').style.display='flex'}
  el('#close-modal').addEventListener('click',()=>el('#overlay').style.display='none');
  // clickable thumbs open preview
  function openPreviewModal(file,url){const info = `<div style="display:flex;gap:12px"><div style="flex:1"><img src="${url}" style="max-width:280px;border-radius:6px"/></div><div style="flex:2"><strong>${file.name}</strong><div style="font-size:12px;color:var(--muted)">${file.type} — ${Math.round(file.size/1024)} KB</div><div style="margin-top:8px"><button class='btn' id='modal-download'>Download</button> <button class='btn' id='modal-insert'>Insert to editor</button></div></div></div>`; showModal(info); setTimeout(()=>{el('#modal-download').addEventListener('click',()=>{const a=document.createElement('a');a.href=url;a.download=file.name;a.click()}); el('#modal-insert').addEventListener('click',()=>{el('#md-input').value += `\n![](${url})\n`; el('#md-input').dispatchEvent(new Event('input')); el('#overlay').style.display='none'} )},100)}

  // attempt to recover saved manifest
  (function recover(){try{const f=JSON.parse(localStorage.getItem('localtool.files')||'[]'); if(f.length){state.files = f; el('#file-list').textContent = f.map(x=>x.name).join('\n'); el('#stat-count').textContent = state.files.length;}}catch(e){console.warn(e)}})();

  // accessible focus for drop
  drop.addEventListener('keydown',e=>{if(e.key==='Enter') el('#file-input').click();});

  // search files
  el('#btn-search').addEventListener('click',()=>{const q=el('#search-files').value.toLowerCase();const res = state.files.filter(f=>f.name.toLowerCase().includes(q));el('#file-list').textContent = res.map(x=>x.name).join('\n')});

  // download all files (zips are complex without libs; just trigger sequential downloads)
  el('#download-all').addEventListener('click',()=>{state.files.forEach(f=>{const a=document.createElement('a');a.href=f.url;a.download=f.name;a.click()});pushLog('downloaded all (one by one)')});

  // file generation sample
  function generateSampleFiles(){ // create a few sample files programmatically
    const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="#081018"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="36" fill="#6ee7b7">Sample '+new Date().toLocaleString()+'</text></svg>';
    const blob = new Blob([svg],{type:'image/svg+xml'}); const url = URL.createObjectURL(blob); const f = {name:'sample-'+Date.now()+'.svg',type:'image/svg+xml',size:blob.size,url}; state.files.push(f); state.images.push({file:{name:f.name,type:f.type,size:f.size},url}); appendThumb({name:f.name},url); updateStats(); pushLog('generated sample svg');}

  // palette color apply
  el('#apply-color').addEventListener('click',()=>{const val = el('#color-swatch').value.trim(); if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(val)){document.documentElement.style.setProperty('--accent',val);pushLog('accent set to '+val)} else {pushLog('invalid color') }});

  // presets in right panel
  els('[data-preset]').forEach(b=>b.addEventListener('click',e=>applyPreset(e.target.dataset.preset)));

  // small UI controls
  el('#font-size').addEventListener('input',e=>{state.settings.fontSize = Number(e.target.value); document.querySelectorAll('.editor').forEach(t=>t.style.fontSize = state.settings.fontSize+'px'); localStorage.setItem('localtool.settings',JSON.stringify(state.settings));});

  // keyboard accessibility: close overlays with Escape
  window.addEventListener('keydown',e=>{if(e.key==='Escape'){el('#overlay').style.display='none';closePalette()}});

  // help and initial sample
  (async function initSample(){const sample = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#08101a"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="48" fill="#6ee7b7">Local Toolkit — Extended</text></svg>');state.files.push({name:'sample.svg',type:'image/svg+xml',size:1024,url:sample});appendThumb({name:'sample.svg'},sample);updateStats();})();

  // small accessibility/UX helpers
  el('#search-files').addEventListener('keydown',e=>{if(e.key==='Enter') el('#btn-search').click()});

  // Save thumbnails click to remove (shift+click)
  el('#thumbs').addEventListener('click',e=>{if(e.target.classList.contains('thumb') && e.shiftKey){const name=e.target.dataset.name; state.files = state.files.filter(f=>f.name!==name); state.images = state.images.filter(i=>i.file.name!==name); e.target.remove(); updateStats(); pushLog('removed '+name)}});

  // make sure initial view is shown and fonts applied
  showView('dashboard'); document.querySelectorAll('.editor').forEach(t=>t.style.fontSize = state.settings.fontSize+'px');

  </script>
</body>
</html>
